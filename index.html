<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PDF編集アプリ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .grid-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .page-block {
      width: calc(50% - 10px); /* 2列表示 */
      border: 2px solid #ccc;
      padding: 5px;
      cursor: pointer;
      position: relative;
    }
    .page-block.selected {
      background-color: #d0f0ff;
      border-color: #007bff;
    }
    canvas {
      width: 100%;
      height: auto;
      display: block;
    }
    .sortable-ghost {
      opacity: 0.4;
    }
    .sortable-chosen {
      outline: 2px dashed #007bff;
    }
  </style>
</head>
<body>
  <h1>PDF編集アプリ</h1>
  <input type="file" id="fileInput" accept="application/pdf" />
  <div style="margin: 10px 0;">
    <button id="deletePagesBtn">選択ページを削除</button>
    <button id="reorderBtn">並び替えを実行</button>
    <button id="downloadBtn">PDFをダウンロード</button>
  </div>
  <div id="pdfContainer" class="grid-container"></div>

  <!-- ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const container = document.getElementById('pdfContainer');
    const deleteBtn = document.getElementById('deletePagesBtn');
    const reorderBtn = document.getElementById('reorderBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    let currentPdfDoc = null;

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      currentPdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
      await renderCurrentPdf();
    });

    async function renderCurrentPdf() {
      const pdfBytes = await currentPdfDoc.save();
      const reloadedPdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

      container.innerHTML = '';

      for (let i = 1; i <= reloadedPdf.numPages; i++) {
        const page = await reloadedPdf.getPage(i);
        const scale = 0.5;
        const viewport = page.getViewport({ scale });

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;

        const pageBlock = document.createElement('div');
        pageBlock.className = 'page-block';
        pageBlock.dataset.index = i - 1;
        pageBlock.appendChild(canvas);

        // 選択トグル
        pageBlock.addEventListener('click', (event) => {
          pageBlock.classList.toggle('selected');
        });

        container.appendChild(pageBlock);
      }

      // 並び替え有効化
      Sortable.create(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen'
      });
    }

    deleteBtn.addEventListener('click', async () => {
      if (!currentPdfDoc) return;

      const selectedBlocks = container.querySelectorAll('.page-block.selected');
      const pagesToDelete = Array.from(selectedBlocks).map(block => parseInt(block.dataset.index));
      if (pagesToDelete.length === 0) {
        alert("削除するページを選択してください。");
        return;
      }

      pagesToDelete.sort((a, b) => b - a); // 後ろから削除
      pagesToDelete.forEach(index => currentPdfDoc.removePage(index));
      await renderCurrentPdf();
    });

    reorderBtn.addEventListener('click', async () => {
      if (!currentPdfDoc) return;

      const pageBlocks = container.querySelectorAll('.page-block');
      const newOrder = Array.from(pageBlocks).map(block => parseInt(block.dataset.index));

      const newPdf = await PDFLib.PDFDocument.create();
      const copiedPages = await newPdf.copyPages(currentPdfDoc, newOrder);
      copiedPages.forEach(p => newPdf.addPage(p));

      currentPdfDoc = newPdf;
      await renderCurrentPdf();
    });

    downloadBtn.addEventListener('click', async () => {
      if (!currentPdfDoc) return;
      const pdfBytes = await currentPdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'edited.pdf';
      a.click();

      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
