<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PDF編集アプリ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .controls { margin: 10px 0; }
    .grid-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
    }
    .page-block {
      width: 20%;
      max-width: 200px;
      border: 2px solid #ccc;
      padding: 4px;
      box-sizing: border-box;
      cursor: pointer;
      position: relative;
    }
    .page-block.selected {
      background-color: #d0f0ff;
      border-color: #007bff;
    }
    canvas {
      width: 100%;
      height: auto;
      display: block;
    }
    .sortable-ghost {
      opacity: 0.4;
    }
    .sortable-chosen {
      outline: 2px dashed #007bff;
    }
    @media (max-width: 768px) {
      .page-block { width: 45%; }
    }
    @media (max-width: 480px) {
      .page-block { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>PDF編集アプリ</h1>
  <p>このツールでは、PDFの結合・表示・並べ替え・削除・ダウンロードが可能です。</p>
  <ol>
    <li>複数のPDFを選択</li>
    <li>ページ選択→削除/並び替え</li>
    <li>PDFをダウンロード</li>
  </ol>

  <input type="file" id="fileInput" accept="application/pdf" multiple />

  <div class="controls">
    <button id="deletePagesBtn">選択ページを削除</button>
    <button id="reorderBtn">並び替えを実行</button>
    <button id="downloadBtn">PDFをダウンロード</button>
    <label style="margin-left: 10px;">拡大率:
      <input type="range" id="scaleSlider" min="0.1" max="1.0" step="0.1" value="0.3">
      <span id="scaleValue">0.3</span>
    </label>
  </div>

  <div id="pdfContainer" class="grid-container"></div>

  <!-- ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    window.pdfjsLib = window['pdfjs-dist/build/pdf'];
  </script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const container = document.getElementById('pdfContainer');
    const deleteBtn = document.getElementById('deletePagesBtn');
    const reorderBtn = document.getElementById('reorderBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const scaleSlider = document.getElementById('scaleSlider');
    const scaleValue = document.getElementById('scaleValue');

    let currentPdfDoc = null;
    let currentScale = parseFloat(scaleSlider.value);

    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      try {
        const mergedPdf = await PDFLib.PDFDocument.create();

        for (const file of files) {
          const arrayBuffer = await file.arrayBuffer();
          const loadedPdf = await PDFLib.PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
          const copiedPages = await mergedPdf.copyPages(loadedPdf, loadedPdf.getPageIndices());
          copiedPages.forEach(p => mergedPdf.addPage(p));
        }

        currentPdfDoc = mergedPdf;
        await renderCurrentPdf();
      } catch (err) {
        alert("PDFの読み込みに失敗しました（暗号化されている可能性があります）");
        console.error(err);
      }
    });

    scaleSlider.addEventListener('input', async () => {
      currentScale = parseFloat(scaleSlider.value);
      scaleValue.textContent = currentScale.toFixed(1);
      if (currentPdfDoc) await renderCurrentPdf();
    });

    async function renderCurrentPdf() {
      const pdfBytes = await currentPdfDoc.save();
      const reloadedPdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
      container.innerHTML = '';

      for (let i = 1; i <= reloadedPdf.numPages; i++) {
        const page = await reloadedPdf.getPage(i);
        const viewport = page.getViewport({ scale: currentScale });

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: context, viewport }).promise;

        const pageBlock = document.createElement('div');
        pageBlock.className = 'page-block';
        pageBlock.dataset.index = i - 1;
        canvas.style.width = '100%';
        canvas.style.height = 'auto';

        pageBlock.appendChild(canvas);
        pageBlock.addEventListener('click', () => {
          pageBlock.classList.toggle('selected');
        });

        container.appendChild(pageBlock);
      }

      Sortable.create(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen'
      });
    }

    deleteBtn.addEventListener('click', async () => {
      if (!currentPdfDoc) return;

      const selectedBlocks = container.querySelectorAll('.page-block.selected');
      const pagesToDelete = Array.from(selectedBlocks).map(block => parseInt(block.dataset.index));
      if (pagesToDelete.length === 0) {
        alert("削除するページを選択してください。");
        return;
      }

      pagesToDelete.sort((a, b) => b - a);
      pagesToDelete.forEach(index => currentPdfDoc.removePage(index));
      await renderCurrentPdf();
    });

    reorderBtn.addEventListener('click', async () => {
      if (!currentPdfDoc) return;

      const pageBlocks = container.querySelectorAll('.page-block');
      const newOrder = Array.from(pageBlocks).map(block => parseInt(block.dataset.index));

      const newPdf = await PDFLib.PDFDocument.create();
      const copiedPages = await newPdf.copyPages(currentPdfDoc, newOrder);
      copiedPages.forEach(p => newPdf.addPage(p));

      currentPdfDoc = newPdf;
      await renderCurrentPdf();
    });

    downloadBtn.addEventListener('click', async () => {
      if (!currentPdfDoc) return;
      const pdfBytes = await currentPdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'edited.pdf';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
